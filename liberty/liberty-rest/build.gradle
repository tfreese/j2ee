plugins {
    id "war"
    id "io.openliberty.tools.gradle.Liberty"
}

description = "Demo for REST-Services"
// https://openliberty.io/guides/gradle-intro.html#getting-started

ext {
    liberty.server.var."default.http.port" = "9080"
    liberty.server.var."default.https.port" = "9443"
    liberty.server.var."app.context.root" = project.name
}

dependencies {
    compileOnly("jakarta.platform:jakarta.jakartaee-api")
    compileOnly("org.eclipse.microprofile:microprofile:6.1")

    testImplementation("com.fasterxml.jackson.jaxrs:jackson-jaxrs-json-provider")
    testImplementation("org.glassfish.jersey.core:jersey-client")
    testImplementation("org.glassfish.jersey.media:jersey-media-json-jackson")
}

test {
    enabled = false

    testLogging {
        events = ["PASSED", "FAILED", "SKIPPED", "STANDARD_OUT", "STANDARD_ERROR"]
//        exceptionFormat = TestExceptionFormat.FULL
    }

    systemProperty "http.port", liberty.server.var."default.http.port"
    systemProperty "context.root", liberty.server.var."app.context.root"
}

tasks.register("openBrowser") {
    group = "MyTasks"
    description = "Open browser to the running application"

    doLast {
        String port = liberty.server.var."default.http.port"
        String context = liberty.server.var."app.context.root"
        String url = "http://localhost:" + port + "/" + context + "/" + "servlet"

        java.awt.Desktop.desktop.browse url.toURI()
        java.awt.Desktop.desktop.browse layout.buildDirectory.get().dir("reports").dir("tests").dir("test").file("index.html")
    }
}

// test.dependsOn "libertyStart"
// test.finalizedBy(openBrowser)
clean.dependsOn "libertyStop"
